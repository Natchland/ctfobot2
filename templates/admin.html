{% extends "base.html" %}
{% block title %}Admin Panel | CTFO{% endblock %}

{% block content %}
<section class="container py-5">

  <!-- Tabs -->
  <ul class="nav nav-tabs mb-4">
    <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#codes">Codes</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#forms">Member&nbsp;Forms</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#giveaways">Giveaways</button></li>
  </ul>

  <!-- Tab panes -->
  <div class="tab-content">

    <!-- CODES -->
    <div class="tab-pane fade show active" id="codes">
      {% include "partials/admin_codes.html" %}
    </div>

<!-- ───────────── MEMBER FORMS ───────────── -->
<div class="tab-pane fade" id="forms">
  {% if forms %}
    <div class="accordion" id="formAcc">
      {% for f in forms %}
        {% set badge =
            'badge-pending'  if f.status=='pending' else
            'badge-accepted' if f.status=='accepted' else
            'badge-denied'   %}
        <div class="accordion-item mb-3">

          <!-- Header -->
          <h2 class="accordion-header" id="h{{f.id}}">
            <button class="accordion-button collapsed" type="button"
                    data-bs-toggle="collapse" data-bs-target="#c{{f.id}}">
              <span class="badge-status {{badge}} me-2">
                {% if f.status=='pending' %}⏳{% elif f.status=='accepted' %}✔{% else %}✖{% endif %}
              </span>
              #{{f.id}} • user {{f.user_id}} • {{f.created_at}}
            </button>
          </h2>

          <!-- Body -->
          <div id="c{{f.id}}" class="accordion-collapse collapse"
               data-bs-parent="#formAcc">
            <div class="accordion-body">

              <!-- JSON editor -->
              <form method="post" action="/forms/update" class="mb-3">
                <input type="hidden" name="id" value="{{f.id}}">
                <textarea name="json" rows="8"
                          class="form-control mb-2">{{ f.data|tojson }}</textarea>
                <button class="btn btn-success">Save</button>
              </form>

              <!-- Action buttons -->
              <div class="d-flex flex-wrap gap-2">
                <!-- Accept -->
                <form method="post" action="/forms/accept">
                  <input type="hidden" name="id" value="{{f.id}}">
                  <button class="btn btn-primary btn-sm"
                          {% if f.status!='pending' %}disabled{% endif %}>
                    Accept
                  </button>
                </form>

                <!-- Deny -->
                <form method="post" action="/forms/deny">
                  <input type="hidden" name="id" value="{{f.id}}">
                  <button class="btn btn-warning btn-sm"
                          {% if f.status!='pending' %}disabled{% endif %}>
                    Deny / Temp-ban
                  </button>
                </form>

                <!-- Delete -->
                <form method="post" action="/forms/delete">
                  <input type="hidden" name="id" value="{{f.id}}">
                  <button class="btn btn-danger btn-sm">Delete</button>
                </form>
              </div>

            </div><!-- /.accordion-body -->
          </div><!-- /.collapse -->
        </div><!-- /.item -->
      {% endfor %}
    </div><!-- /.accordion -->
  {% else %}
    <div class="alert alert-secondary text-center">
      No member forms stored.
    </div>
  {% endif %}
</div><!-- /.tab-pane -->

    <!-- GIVEAWAYS -->
    <div class="tab-pane fade" id="giveaways">
      {% if gws %}
        <div class="table-responsive">
          <table class="table table-dark table-striped align-middle">
            <thead>
              <tr><th>ID</th><th>Prize</th><th>Ends&nbsp;(unix)</th><th>Active?</th><th>Note</th><th>Actions</th></tr>
            </thead>
            <tbody>
              {% for g in gws %}
                <tr>
                  <form method="post" action="/giveaways/update">
                    <td><code>{{ g.id }}</code></td>
                    <td><input name="prize" class="form-control form-control-sm" value="{{ g.prize }}"></td>
                    <td><input name="end_ts" class="form-control form-control-sm" type="number" value="{{ g.end_ts }}"></td>
                    <td>{{ '✅' if g.active else '⛔' }}</td>
                    <td><input name="note" class="form-control form-control-sm" value="{{ g.note or '' }}"></td>
                    <td class="d-flex gap-2">
                      <input type="hidden" name="id" value="{{ g.id }}">
                      <button class="btn btn-sm btn-success">Save</button>
                  </form>
                  <form method="post" action="/giveaways/end">
                      <input type="hidden" name="id" value="{{ g.id }}">
                      <button class="btn btn-sm btn-warning" {% if not g.active %}disabled{% endif %}>End</button>
                  </form>
                    </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="alert alert-info">No giveaways yet.</div>
      {% endif %}
    </div>

  </div><!-- /.tab-content -->

  <footer class="text-muted text-center mt-5">&copy; {{ year }} CTFO Gaming</footer>
</section>
{% endblock %}