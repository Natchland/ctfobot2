{% extends "base.html" %}
{% block title %}Admin Panel | CTFO{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
{% endblock %}

{% block content %}
<section class="container py-5">

  <!-- Tabs -->
  <ul class="nav nav-tabs mb-4">
    <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#codes">Codes</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#forms">Member&nbsp;Forms</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#giveaways">Giveaways</button></li>
  </ul>

  <div class="tab-content">

    <!-- CODES -->
    <div class="tab-pane fade show active" id="codes">
      {% include "partials/admin_codes.html" %}
    </div>

    <!-- MEMBER FORMS: DataTable -->
    <div class="tab-pane fade" id="forms">
      <table id="formsTable" class="table table-striped align-middle w-100">
        <thead>
          <tr>
            <th></th>
            <th>Status</th>
            <th>ID</th>
            <th>User&nbsp;ID</th>
            <th>Created</th>
            <th style="width:110px;">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% if forms %}
            {% for f in forms %}
              {% set badge =
                'badge-pending'  if f.status=='pending' else
                'badge-accepted' if f.status=='accepted' else
                'badge-denied'   %}
              <tr data-form='{{ f.data|tojson | safe }}'>
                <td class="details-control"><i class="fa-solid fa-caret-right fa-lg"></i></td>
                <td>
                  <span class="badge-status {{badge}}">
                    {% if f.status=='pending' %}<i class="fa fa-hourglass-half"></i>
                    {% elif f.status=='accepted' %}<i class="fa fa-check"></i>
                    {% else %}<i class="fa fa-ban"></i>{% endif %}
                  </span>
                </td>
                <td>{{f.id}}</td>
                <td>{{f.user_id}}</td>
                <td>
                  {% if f.created_at %}
                    {{ f.created_at.strftime('%Y-%m-%d %H:%M') }}
                  {% else %}
                    N/A
                  {% endif %}
                </td>
                <td class="d-flex gap-1">
                  <button class="btn btn-sm btn-success action-btn" data-id="{{f.id}}" data-action="accept"
                    {% if f.status!='pending' %}disabled{% endif %}>
                    <i class="fa fa-check"></i>
                  </button>
                  <button class="btn btn-sm btn-warning action-btn" data-id="{{f.id}}" data-action="deny"
                    {% if f.status!='pending' %}disabled{% endif %}>
                    <i class="fa fa-ban"></i>
                  </button>
                  <button class="btn btn-sm btn-danger action-btn" data-id="{{f.id}}" data-action="delete">
                    <i class="fa fa-trash"></i>
                  </button>
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="6" class="text-center text-muted">No member forms stored.</td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    <!-- GIVEAWAYS -->
    <div class="tab-pane fade" id="giveaways">
      {% if gws %}
        <div class="table-responsive">
          <table class="table table-dark table-striped align-middle">
            <thead>
              <tr><th>ID</th><th>Prize</th><th>Ends&nbsp;(unix)</th><th>Active?</th><th>Note</th><th>Actions</th></tr>
            </thead>
            <tbody>
              {% for g in gws %}
                <tr>
                  <form method="post" action="/giveaways/update">
                    <td><code>{{ g.id }}</code></td>
                    <td><input name="prize" class="form-control form-control-sm" value="{{ g.prize }}"></td>
                    <td><input name="end_ts" class="form-control form-control-sm" type="number" value="{{ g.end_ts }}"></td>
                    <td>{{ '✅' if g.active else '⛔' }}</td>
                    <td><input name="note" class="form-control form-control-sm" value="{{ g.note or '' }}"></td>
                    <td class="d-flex gap-2">
                      <input type="hidden" name="id" value="{{ g.id }}">
                      <button class="btn btn-sm btn-success">Save</button>
                  </form>
                  <form method="post" action="/giveaways/end">
                      <input type="hidden" name="id" value="{{ g.id }}">
                      <button class="btn btn-sm btn-warning" {% if not g.active %}disabled{% endif %}>End</button>
                  </form>
                    </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="alert alert-info">No giveaways yet.</div>
      {% endif %}
    </div>
  </div>

  <footer class="text-muted text-center mt-5">&copy; {{ year }} CTFO Gaming</footer>
</section>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/js/all.min.js"></script>
<script>
const ICON = {
  age      :['fa-calendar',    'Age'],
  region   :['fa-globe',       'Region'],
  bans     :['fa-ban',         'Bans'],
  ban_explanation:['fa-note-sticky','Ban explanation'],
  focus    :['fa-bullseye',    'Focus'],
  skill    :['fa-star',        'Skill'],
  steam    :['fa-link',        'Steam'],
  hours    :['fa-clock',       'Hours'],
  heard    :['fa-bullhorn',    'Heard'],
  referral :['fa-handshake',   'Referral'],
  gender   :['fa-person',      'Gender']
};
const ORDER = [
  "steam", "age", "region", "bans", "ban_explanation", "focus",
  "skill", "hours", "heard", "referral", "gender"
];

function card(k, v) {
  const [ico, label] = ICON[k] ?? ['fa-circle-question', k];
  return `<div class="col-6 col-lg-3 field-card mb-3">
    <div class="label"><i class="fa ${ico} me-1"></i>${label}</div>
    <div class="value">${v ?? 'N/A'}</div>
  </div>`;
}
function makeChild(form_data) {
  let html = '<div class="child-panel row g-4">';
  for (const k of ORDER) if (k in form_data) html += card(k, form_data[k]);
  for (const k of Object.keys(form_data)) if (!ORDER.includes(k)) html += card(k, form_data[k]);
  return html + '</div>';
}

$(function() {
  const table = $('#formsTable').DataTable({
    order: [[2, 'desc']], pageLength: 25,
    columnDefs: [{targets:[0,1,5], orderable:false}]
  });

  $('#formsTable tbody').on('click','td.details-control',function(){
     const tr = $(this).closest('tr');
     const row = table.row(tr);
     const formData = JSON.parse(tr.attr('data-form') || '{}');
     row.child.isShown()
       ? (row.child.hide(), tr.removeClass('shown'))
       : (row.child(makeChild(formData)).show(), tr.addClass('shown'));
  });

  // AJAX actions for Accept/Deny/Delete
  $('#formsTable').on('click', '.action-btn', function() {
    const id = $(this).data('id');
    const action = $(this).data('action');
    if(!id || !action) return;
    let url = `/forms/${action}`;
    let btn = $(this);
    btn.prop('disabled', true);

    $.post(url, {id: id})
      .done(function(resp) {
        const row = btn.closest('tr');
        if(action === 'delete') {
          table.row(row).remove().draw();
        } else if(resp && resp.status) {
          // Update badge
          let badgeCell = row.find('td').eq(1).find('.badge-status');
          if(action === 'accept') {
            badgeCell.removeClass().addClass('badge-status badge-accepted').html('<i class="fa fa-check"></i>');
          } else if(action === 'deny') {
            badgeCell.removeClass().addClass('badge-status badge-denied').html('<i class="fa fa-ban"></i>');
          }
          // Disable all except delete button
          row.find('.action-btn').not('[data-action="delete"]').prop('disabled', true);
        } else if(resp && resp.error) {
          alert(resp.error);
          btn.prop('disabled', false);
        }
      })
      .fail(function(xhr) {
        let msg = "Error processing action.";
        if(xhr.responseJSON && xhr.responseJSON.error) msg = xhr.responseJSON.error;
        alert(msg);
        btn.prop('disabled', false);
      });
  });
});
</script>
{% endblock %}