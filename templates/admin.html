{% extends "base.html" %}
{% block title %}Admin Panel | CTFO{% endblock %}

{% block extra_head %}
<!-- DataTables (Bootstrap 5 theme) -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
<!-- FontAwesome 6 -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
/* DataTables/Member Forms custom styles */
.table thead{background:#121216;}
table.dataTable tbody td,
table.dataTable thead th{color:#fff !important;}

td.details-control{cursor:pointer;text-align:center;width:28px;}
td.details-control i{color:var(--ctfo-red);filter:drop-shadow(0 0 3px var(--ctfo-red));
                     transition:transform .25s;}
tr.shown td.details-control i{transform:rotate(90deg);}

/* status badge */
.badge-status{width:26px;height:26px;display:flex;align-items:center;justify-content:center;
              border-radius:50%;font-size:.8rem;}
.badge-pending {background:var(--ctfo-yellow);}
.badge-accepted{background:var(--ctfo-green);}
.badge-denied  {background:var(--ctfo-red);box-shadow:0 0 6px var(--ctfo-red);}

/* buttons */
.btn-success{background:var(--ctfo-green);border:0;}
.btn-warning{background:var(--ctfo-yellow);border:0;color:#000;}
.btn-danger {background:var(--ctfo-red);border:0;box-shadow:0 0 6px rgba(255,48,48,.5);}
.btn:disabled{opacity:.35!important;}

/* DataTables search / length controls */
.dataTables_wrapper .form-select,
.dataTables_wrapper .dataTables_filter input{background:#1c1c1f;border:1px solid #444;color:#fff;}

/* child row -----------------------------------------------------*/
tr.child td{background:transparent;border:0;padding:0 !important;}

.child-panel{
  width:100%;box-sizing:border-box;
  background:var(--ctfo-panel);
  border-left:4px solid var(--ctfo-red);
  box-shadow:0 0 8px rgba(255,48,48,.6);

  margin-top:10px;                       /* gap reduced to 10 px */
  padding:1.2rem 1.4rem 1.2rem 70px;     /* indent clears caret+badge */
}
.field-card .label{
  font-size:.72rem;text-transform:uppercase;color:#ccc;letter-spacing:.4px;
}
.field-card .label i{color:#ccc;}
.field-card .value{
  font-weight:600;color:var(--ctfo-red);text-shadow:0 0 5px var(--ctfo-red);
  word-break:break-word;
}
</style>
{% endblock %}

{% block content %}
<section class="container py-5">

  <!-- Tabs -->
  <ul class="nav nav-tabs mb-4">
    <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#codes">Codes</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#forms">Member&nbsp;Forms</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#giveaways">Giveaways</button></li>
  </ul>

  <!-- Tab panes -->
  <div class="tab-content">

    <!-- CODES -->
    <div class="tab-pane fade show active" id="codes">
      {% include "partials/admin_codes.html" %}
    </div>

    <!-- MEMBER FORMS: DataTable -->
    <div class="tab-pane fade" id="forms">
      {% if forms %}
        <table id="formsTable" class="table table-striped align-middle w-100">
          <thead>
            <tr>
              <th></th>
              <th>Status</th>
              <th>ID</th>
              <th>User&nbsp;ID</th>
              <th>Created</th>
              <th style="width:110px;">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for f in forms %}
              {% set badge =
                'badge-pending'  if f.status=='pending' else
                'badge-accepted' if f.status=='accepted' else
                'badge-denied'   %}
              <tr data-form='{{ f.data|tojson | safe }}'>
                <td class="details-control"><i class="fa-solid fa-caret-right fa-lg"></i></td>
                <td>
                  <span class="badge-status {{badge}}">
                    {% if f.status=='pending' %}<i class="fa fa-hourglass-half"></i>
                    {% elif f.status=='accepted' %}<i class="fa fa-check"></i>
                    {% else %}<i class="fa fa-ban"></i>{% endif %}
                  </span>
                </td>
                <td>{{f.id}}</td>
                <td>{{f.user_id}}</td>
                <td>{{f.created_at.strftime('%Y-%m-%d %H:%M')}}</td>
                <td class="d-flex gap-1">
                  <form method="post" action="/forms/accept" style="display:inline;">
                    <input type="hidden" name="id" value="{{f.id}}">
                    <button class="btn btn-sm btn-success" {% if f.status!='pending' %}disabled{% endif %}>
                      <i class="fa fa-check"></i>
                    </button>
                  </form>
                  <form method="post" action="/forms/deny" style="display:inline;">
                    <input type="hidden" name="id" value="{{f.id}}">
                    <button class="btn btn-sm btn-warning" {% if f.status!='pending' %}disabled{% endif %}>
                      <i class="fa fa-ban"></i>
                    </button>
                  </form>
                  <form method="post" action="/forms/delete" style="display:inline;">
                    <input type="hidden" name="id" value="{{f.id}}">
                    <button class="btn btn-sm btn-danger"><i class="fa fa-trash"></i></button>
                  </form>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="alert alert-secondary text-center">
          No member forms stored.
        </div>
      {% endif %}
    </div><!-- /.tab-pane -->

    <!-- GIVEAWAYS -->
    <div class="tab-pane fade" id="giveaways">
      {% if gws %}
        <div class="table-responsive">
          <table class="table table-dark table-striped align-middle">
            <thead>
              <tr><th>ID</th><th>Prize</th><th>Ends&nbsp;(unix)</th><th>Active?</th><th>Note</th><th>Actions</th></tr>
            </thead>
            <tbody>
              {% for g in gws %}
                <tr>
                  <form method="post" action="/giveaways/update">
                    <td><code>{{ g.id }}</code></td>
                    <td><input name="prize" class="form-control form-control-sm" value="{{ g.prize }}"></td>
                    <td><input name="end_ts" class="form-control form-control-sm" type="number" value="{{ g.end_ts }}"></td>
                    <td>{{ '✅' if g.active else '⛔' }}</td>
                    <td><input name="note" class="form-control form-control-sm" value="{{ g.note or '' }}"></td>
                    <td class="d-flex gap-2">
                      <input type="hidden" name="id" value="{{ g.id }}">
                      <button class="btn btn-sm btn-success">Save</button>
                  </form>
                  <form method="post" action="/giveaways/end">
                      <input type="hidden" name="id" value="{{ g.id }}">
                      <button class="btn btn-sm btn-warning" {% if not g.active %}disabled{% endif %}>End</button>
                  </form>
                    </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="alert alert-info">No giveaways yet.</div>
      {% endif %}
    </div>

  </div><!-- /.tab-content -->

  <footer class="text-muted text-center mt-5">&copy; {{ year }} CTFO Gaming</footer>
</section>
{% endblock %}

{% block extra_js %}
<script>
const ICON = {
  age      :['fa-calendar',    'Age'],
  region   :['fa-globe',       'Region'],
  bans     :['fa-ban',         'Bans'],
  ban_explanation:['fa-note-sticky','Ban explanation'],
  focus    :['fa-bullseye',    'Focus'],
  skill    :['fa-star',        'Skill'],
  steam    :['fa-link',        'Steam'],
  hours    :['fa-clock',       'Hours'],
  heard    :['fa-bullhorn',    'Heard'],
  referral :['fa-handshake',   'Referral'],
  gender   :['fa-person',      'Gender']
};
const ORDER = [
  "steam", "age", "region", "bans", "ban_explanation", "focus",
  "skill", "hours", "heard", "referral", "gender"
];

function card(k, v) {
  const [ico, label] = ICON[k] ?? ['fa-circle-question', k];
  return `<div class="col-6 col-lg-3 field-card mb-3">
    <div class="label"><i class="fa ${ico} me-1"></i>${label}</div>
    <div class="value">${v ?? 'N/A'}</div>
  </div>`;
}
function makeChild(form_data) {
  let html = '<div class="child-panel row g-4">';
  for (const k of ORDER) if (k in form_data) html += card(k, form_data[k]);
  for (const k of Object.keys(form_data)) if (!ORDER.includes(k)) html += card(k, form_data[k]);
  return html + '</div>';
}

$(function() {
  const table = $('#formsTable').DataTable({
    order: [[2, 'desc']], pageLength: 25,
    columnDefs: [{targets:[0,1,5], orderable:false}]
  });

  $('#formsTable tbody').on('click','td.details-control',function(){
     const tr = $(this).closest('tr');
     const row = table.row(tr);
     const formData = JSON.parse(tr.attr('data-form') || '{}');
     row.child.isShown()
       ? (row.child.hide(), tr.removeClass('shown'))
       : (row.child(makeChild(formData)).show(), tr.addClass('shown'));
  });
});
</script>
{% endblock %}